<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>لوحة التحكم - محرر الفحام للمعلوميات</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f9f9f9;
      margin: 0; padding: 15px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
      min-height: 100vh;
    }
    h2 {
      text-align: center;
      color: #0b2545;
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: 700;
      margin-bottom: 6px;
      color: #0b2545;
    }
    input[type="text"], input[type="url"], input[type="file"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    #thumbnailPreview {
      max-width: 200px;
      margin-bottom: 20px;
      border-radius: 8px;
      display: none;
      box-shadow: 0 0 8px rgba(11, 37, 69, 0.3);
      cursor: pointer;
      object-fit: contain;
      max-height: 150px;
    }

    #toolbar {
      background: #0b2545;
      border-radius: 6px;
      padding: 6px 10px;
      margin-bottom: 20px; /* مسافة بين الأدوات والمحرر */
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    #toolbar button, #toolbar select {
      background: white;
      border: none;
      border-radius: 4px;
      padding: 5px 9px;
      cursor: pointer;
      font-size: 13px;
      min-width: 30px;
      text-align: center;
      user-select: none;
      transition: background 0.3s;
      flex-shrink: 0;
    }
    #toolbar button:hover, #toolbar select:hover {
      background: #ddd;
    }
    #toolbar button.active {
      background: #ffce00;
    }

    #editor {
      width: 100%;
      min-height: 400px;
      background: white;
      border-radius: 6px;
      padding: 15px;
      overflow-y: auto;
      outline: none;
      box-sizing: border-box;
      border: 1px solid #ccc;
      font-size: 16px;
      line-height: 1.6;
      color: #0b2545;
      word-break: break-word;
    }

    #editor img,
    #editor video,
    #editor iframe {
      max-width: 100% !important;
      height: auto !important;
      border-radius: 8px;
      display: block;
      margin: 10px auto;
    }

    #htmlInput {
      width: 100%;
      min-height: 200px;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-top: 15px;
      display: none;
      resize: vertical;
    }
    #publishBtn {
      background: #0b2545;
      color: white;
      padding: 14px 20px;
      font-size: 18px;
      width: 100%;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 25px;
      transition: background 0.3s;
    }
    #publishBtn:hover {
      background: #163a78;
    }
    #posts {
      margin-top: 30px;
    }
    .post {
      background: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 0 6px rgb(0 0 0 / 0.1);
      position: relative;
      color: #0b2545;
    }
    .post h4 {
      margin: 0 0 10px 0;
      font-size: 20px;
      cursor: pointer;
    }
    .post .actions {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 8px;
    }
    .post button {
      background: #d32f2f;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .post button.edit-btn {
      background: #1976d2;
    }
    .post button:hover {
      opacity: 0.8;
    }
    @media (max-width: 600px) {
      #toolbar {
        overflow-x: auto;
      }
      #thumbnailPreview {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <h2>إضافة / تعديل مشاركة</h2>

  <label for="title">عنوان المشاركة:</label>
  <input type="text" id="title" placeholder="اكتب عنوان المشاركة هنا..." />

  <label for="imageUrl">رابط صورة كارت المشاركة (مصغرة):</label>
  <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg" />
  
  <label for="imageFile">أو رفع صورة كارت المشاركة من جهازك:</label>
  <input type="file" id="imageFile" accept="image/*" />

  <img id="thumbnailPreview" alt="معاينة صورة الكارت" title="انقر لإزالة الصورة" />

  <div id="toolbar" aria-label="شريط أدوات التحرير">
    <button type="button" onclick="execCmd('selectAll')" title="تحديد كل النص">تحديد الكل</button>
    <button type="button" onclick="execCmd('bold')" title="عريض (Ctrl+B)"><b>B</b></button>
    <button type="button" onclick="execCmd('italic')" title="مائل (Ctrl+I)"><i>I</i></button>
    <button type="button" onclick="execCmd('underline')" title="تسطير (Ctrl+U)"><u>U</u></button>

    <select id="fontSizeSelector" onchange="execCmdWithValue('fontSize', this.value)" title="حجم الخط">
      <option value="">حجم الخط</option>
      <option value="1">صغير جداً</option>
      <option value="2">صغير</option>
      <option value="3" selected>متوسط</option>
      <option value="4">كبير</option>
      <option value="5">أكبر</option>
      <option value="6">ضخم</option>
      <option value="7">ضخم جداً</option>
    </select>

    <button type="button" onclick="execCmd('justifyRight')" title="محاذاة يمين">يمين</button>
    <button type="button" onclick="execCmd('justifyCenter')" title="محاذاة وسط">وسط</button>
    <button type="button" onclick="execCmd('justifyLeft')" title="محاذاة يسار">يسار</button>

    <button type="button" onclick="insertImageFromDevice()" title="رفع صورة من جهازك">📤🖼️</button>
    <button type="button" onclick="insertImage()" title="إضافة صورة من رابط">🖼️</button>
    <button type="button" onclick="insertLinkImage()" title="إضافة صورة مع رابط">🔗🖼️</button>
    <button type="button" onclick="insertYoutube()" title="إضافة فيديو يوتيوب">▶️</button>
    <button type="button" onclick="toggleHtml()" title="تعديل كود HTML خام">HTML</button>
  </div>

  <div id="editor" contenteditable="true" spellcheck="true" aria-label="محرر النص"></div>
  <textarea id="htmlInput" aria-label="كود HTML للمحرر"></textarea>

  <button id="publishBtn">نشر المشاركة</button>

  <div id="posts" aria-live="polite"></div>

  <input type="file" id="hiddenImageInput" accept="image/*" style="display:none;" />

<script>
  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCcXWs8SCvzUmLaqdxBe6rTGaRPqvz7BBc",
    authDomain: "alfaham-info.firebaseapp.com",
    databaseURL: "https://alfaham-info-default-rtdb.firebaseio.com/",
    projectId: "alfaham-info",
    storageBucket: "alfaham-info.appspot.com",
    messagingSenderId: "383796585349",
    appId: "1:383796585349:web:c3346dcd6fcfecf733daec"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // المتغيرات
  const titleInput = document.getElementById("title");
  const imageUrlInput = document.getElementById("imageUrl");
  const imageFileInput = document.getElementById("imageFile");
  const thumbnailPreview = document.getElementById("thumbnailPreview");
  const editor = document.getElementById("editor");
  const htmlInput = document.getElementById("htmlInput");
  const publishBtn = document.getElementById("publishBtn");
  const fontSizeSelector = document.getElementById("fontSizeSelector");
  const hiddenImageInput = document.getElementById("hiddenImageInput");

  let htmlMode = false;
  let editingId = null;

  // تحديث معاينة صورة الكارت عند تغيير رابطها
  imageUrlInput.addEventListener("input", () => {
    const url = imageUrlInput.value.trim();
    if(url) {
      thumbnailPreview.src = url;
      thumbnailPreview.style.display = "block";
      imageFileInput.value = ""; // امسح اختيار الملف لو كان موجود
    } else {
      if(!imageFileInput.value) {
        thumbnailPreview.style.display = "none";
        thumbnailPreview.src = "";
      }
    }
  });

  // رفع صورة كارت المشاركة من الجهاز وعرضها
  imageFileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        thumbnailPreview.src = evt.target.result;
        thumbnailPreview.style.display = "block";
        imageUrlInput.value = ""; // مسح رابط الصورة لو كان موجود
      };
      reader.readAsDataURL(file);
    } else {
      if(!imageUrlInput.value) {
        thumbnailPreview.style.display = "none";
        thumbnailPreview.src = "";
      }
    }
  });

  // إزالة صورة كارت المشاركة عند النقر عليها
  thumbnailPreview.addEventListener("click", () => {
    if(confirm("هل تريد إزالة صورة كارت المشاركة؟")) {
      thumbnailPreview.style.display = "none";
      thumbnailPreview.src = "";
      imageUrlInput.value = "";
      imageFileInput.value = "";
    }
  });

  // دوال شريط الأدوات:

  // تنفيذ أوامر محرر النص
  function execCmd(command) {
    if (htmlMode) return alert("عليك إيقاف وضع تعديل الكود أولاً");
    document.execCommand(command, false, null);
    syncFontSizeSelector();
  }
  function execCmdWithValue(command, value) {
    if (htmlMode) return alert("عليك إيقاف وضع تعديل الكود أولاً");
    if(value) document.execCommand(command, false, value);
    syncFontSizeSelector();
  }

  // مزامنة حجم الخط مع القائمة
  function syncFontSizeSelector(){
    let size = document.queryCommandValue("fontSize");
    if(size){
      fontSizeSelector.value = size;
    } else {
      fontSizeSelector.value = "";
    }
  }

  // إدراج صورة من رابط مع طلب أبعاد اختيارية
  function insertImage(){
    if(htmlMode) return alert("عليك إيقاف وضع تعديل الكود أولاً");
    const url = prompt("أدخل رابط الصورة:");
    if(url){
      const width = prompt("أدخل عرض الصورة بالبكسل (أو اتركه فارغاً للعرض الكامل):");
      const height = prompt("أدخل ارتفاع الصورة بالبكسل (أو اتركه فارغاً للارتفاع التلقائي):");
      let imgTag = `<img src="${url}" alt="صورة" style="max-width:100%;${width?'width:'+width+'px;':''}${height?'height:'+height+'px;':''}">`;
      insertHtmlAtCursor(imgTag);
    }
  }

  // إدراج صورة قابلة للضغط تفتح رابط + أبعاد اختيارية
  function insertLinkImage(){
    if(htmlMode) return alert("عليك إيقاف وضع تعديل الكود أولاً");
    const url = prompt("أدخل رابط الصورة:");
    if(!url) return;
    const link = prompt("أدخل رابط الرابط (الرابط الذي سيفتح عند الضغط على الصورة):");
    if(!link) return;
    const width = prompt("أدخل عرض الصورة بالبكسل (أو اتركه فارغاً للعرض الكامل):");
    const height = prompt("أدخل ارتفاع الصورة بالبكسل (أو اتركه فارغاً للارتفاع التلقائي):");
    let imgTag = `<a href="${link}" target="_blank"><img src="${url}" alt="صورة قابلة للنقر" style="max-width:100%;${width?'width:'+width+'px;':''}${height?'height:'+height+'px;':''}"></a>`;
    insertHtmlAtCursor(imgTag);
  }

  // إدراج فيديو يوتيوب مع المعاينة
  function insertYoutube(){
    if(htmlMode) return alert("عليك إيقاف وضع تعديل الكود أولاً");
    const url = prompt("أدخل رابط فيديو يوتيوب:");
    if(url){
      const videoId = extractYoutubeID(url);
      if(videoId){
        const width = prompt("أدخل عرض الفيديو بالبكسل (أو اتركه فارغاً للعرض الكامل):");
        const height = prompt("أدخل ارتفاع الفيديو بالبكسل (أو اتركه فارغاً للارتفاع التلقائي):");
        let style = 'max-width:100%;border-radius:8px;';
        if(width) style += `width:${width}px;`;
        if(height) style += `height:${height}px;`;
        const iframe = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen style="${style}"></iframe>`;
        insertHtmlAtCursor(iframe);
      } else {
        alert("الرابط غير صحيح.");
      }
    }
  }

  // استخراج ID فيديو يوتيوب من الرابط
  function extractYoutubeID(url) {
    const regex = /(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
  }

  // إدراج صورة مرفوعة من الجهاز
  function insertImageFromDevice(){
    if(htmlMode) return alert("عليك إيقاف وضع تعديل الكود أولاً");
    hiddenImageInput.click();
  }
  hiddenImageInput.addEventListener("change", () => {
    const file = hiddenImageInput.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      // نسأل عن الأبعاد بعد قراءة الصورة
      const width = prompt("أدخل عرض الصورة بالبكسل (أو اتركه فارغاً للعرض الكامل):");
      const height = prompt("أدخل ارتفاع الصورة بالبكسل (أو اتركه فارغاً للارتفاع التلقائي):");
      let imgTag = `<img src="${e.target.result}" alt="صورة مرفوعة" style="max-width:100%;${width?'width:'+width+'px;':''}${height?'height:'+height+'px;':''}">`;
      insertHtmlAtCursor(imgTag);
      hiddenImageInput.value = ""; // إعادة تعيين input
    };
    reader.readAsDataURL(file);
  });

  // إدراج HTML في موقع المؤشر الحالي
  function insertHtmlAtCursor(html) {
    let sel, range;
    if(window.getSelection){
      sel = window.getSelection();
      if(sel.getRangeAt && sel.rangeCount){
        range = sel.getRangeAt(0);
        range.deleteContents();
        let el = document.createElement("div");
        el.innerHTML = html;
        let frag = document.createDocumentFragment(), node, lastNode;
        while((node = el.firstChild)){
          lastNode = frag.appendChild(node);
        }
        range.insertNode(frag);
        if(lastNode){
          range = range.cloneRange();
          range.setStartAfter(lastNode);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }
    syncFontSizeSelector();
  }

  // تبديل بين وضع تعديل الكود و المحرر العادي
  function toggleHtml(){
    if(htmlMode){
      // من الكود إلى المحرر
      editor.innerHTML = htmlInput.value;
      htmlInput.style.display = "none";
      editor.style.display = "block";
      publishBtn.disabled = false;
      htmlMode = false;
    } else {
      // من المحرر إلى الكود
      htmlInput.value = editor.innerHTML;
      htmlInput.style.display = "block";
      editor.style.display = "none";
      publishBtn.disabled = true;
      htmlMode = true;
    }
  }

  // زر النشر/التحديث
  publishBtn.addEventListener("click", () => {
    const title = titleInput.value.trim();
    const content = editor.innerHTML.trim();
    let imageUrl = imageUrlInput.value.trim();

    // إذا رفع المستخدم صورة كارت من الجهاز، نستخدمها بدل الرابط
    if(!imageUrl && thumbnailPreview.style.display === "block" && imageFileInput.files.length > 0){
      // نستخدم بيانات صورة مرفوعة على شكل Base64 فقط (نظام تخزين بيانات مباشر)
      imageUrl = thumbnailPreview.src;
    }

    if(!title) return alert("يرجى إدخال عنوان المشاركة.");
    if(!content) return alert("يرجى إدخال محتوى المشاركة.");

    if(editingId){
      db.ref("articles/" + editingId).set({ title, imageUrl, content })
        .then(() => {
          alert("تم تحديث المشاركة بنجاح.");
          resetForm();
          loadPosts();
        })
        .catch(err => alert("خطأ في تحديث المشاركة: " + err.message));
    } else {
      const newKey = db.ref("articles").push().key;
      db.ref("articles/" + newKey).set({ title, imageUrl, content })
        .then(() => {
          alert("تم نشر المشاركة بنجاح.");
          resetForm();
          loadPosts();
        })
        .catch(err => alert("خطأ في نشر المشاركة: " + err.message));
    }
  });

  // إعادة تعيين النموذج
  function resetForm() {
    editingId = null;
    titleInput.value = "";
    imageUrlInput.value = "";
    imageFileInput.value = "";
    thumbnailPreview.style.display = "none";
    thumbnailPreview.src = "";
    editor.innerHTML = "";
    htmlInput.value = "";
    publishBtn.textContent = "نشر المشاركة";
    fontSizeSelector.value = "3";
    if(htmlMode) toggleHtml();
  }

  // تحميل المشاركات وعرضها مع أزرار تعديل وحذف
  const postsContainer = document.getElementById("posts");

  function loadPosts() {
    postsContainer.innerHTML = "جارٍ تحميل المشاركات...";
    db.ref("articles").once("value").then(snapshot => {
      const data = snapshot.val();
      postsContainer.innerHTML = "";
      if(!data) {
        postsContainer.innerHTML = "<p style='text-align:center;'>لا توجد مشاركات حالياً.</p>";
        return;
      }

      Object.entries(data).reverse().forEach(([id, article]) => {
        const postDiv = document.createElement("div");
        postDiv.className = "post";
        postDiv.innerHTML = `
          <h4 title="اضغط للتعديل">${article.title}</h4>
          <div class="actions">
            <button class="edit-btn">✏️ تعديل</button>
            <button class="delete-btn">🗑 حذف</button>
          </div>
        `;
        // عند الضغط على تعديل
        postDiv.querySelector(".edit-btn").addEventListener("click", () => {
          editingId = id;
          titleInput.value = article.title || "";
          imageUrlInput.value = article.imageUrl || "";
          if(article.imageUrl){
            thumbnailPreview.src = article.imageUrl;
            thumbnailPreview.style.display = "block";
          } else {
            thumbnailPreview.style.display = "none";
            thumbnailPreview.src = "";
          }
          if(htmlMode){
            toggleHtml();
          }
          editor.innerHTML = article.content || "";
          publishBtn.textContent = "تحديث المشاركة";
          fontSizeSelector.value = "3"; // تعيين الحجم الافتراضي عند التحميل
          window.scrollTo({top:0, behavior:"smooth"});
        });
        // عند الضغط على حذف
        postDiv.querySelector(".delete-btn").addEventListener("click", () => {
          if(confirm("هل تريد حذف المشاركة؟")){
            db.ref("articles/" + id).remove()
              .then(() => {
                if(editingId === id) resetForm();
                loadPosts();
              })
              .catch(err => alert("خطأ أثناء الحذف: " + err.message));
          }
        });

        postsContainer.appendChild(postDiv);
      });
    });
  }

  // مزامنة حجم الخط مع القائمة عند تغير اختيار المستخدم أو تحديد نص في المحرر
  editor.addEventListener("keyup", syncFontSizeSelector);
  editor.addEventListener("mouseup", syncFontSizeSelector);
  editor.addEventListener("focus", syncFontSizeSelector);

  // تحميل المشاركات عند بدء الصفحة
  loadPosts();
</script>

</body>
</html>
